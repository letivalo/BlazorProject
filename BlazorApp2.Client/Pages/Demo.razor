@page "/demo"
@rendermode InteractiveAuto
@using System.Net.Http.Json
@using BlazorApp2.Client
@using static System.Net.Http.HttpClient;

<PageTitle>Project Demo</PageTitle>

<div class="article">
    <div class="headingcontainer">
        <img src="/icons/projectdemo.svg" class="aboutprojectimg"/><h1>To-Do List Demo</h1>
        <h3>(@todos.Count(todo => !todo.IsDone)) Tasks Currently In Progress</h3>
    </div>
<ul>
    @foreach (var todo in todos)
        {
            <li>
                <input type="checkbox" @bind="todo.IsDone" />
                <input type="text" @bind="todo.Title" />
            </li>
        }
    </ul>
</div>

<!-- Task input kept outside of Article div for spacing -->
<input class="createTask" type="text" @bind="newTodo" />
<button @onclick="AddTodo">Create Task</button>

@code {


    // This entire block of code makes perfect sense so long as you've recently been severely concussed. Sheesh I still have a lot to learn.

    private List<Todos> todos = new();
    private string newTodo = string.Empty;

    [Inject] private HttpClient Http { get; set; } = null!;
    [Inject] private NavigationManager Navigation { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        await LoadTodosFromDatabase();
    }

    private async Task LoadTodosFromDatabase()
    {
        try
        {
            // Fetch all todos from the API
            var baseUrl = Navigation.BaseUri;
            todos = await Http.GetFromJsonAsync<List<Todos>>(baseUrl + "Todos");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading todos: {ex.Message}");
        }
    }

    private async Task AddTodo()
    {
        if (!string.IsNullOrWhiteSpace(newTodo))
        {
            // Create the new todo item locally temporarily
            var newTask = new Todos { Title = newTodo, IsDone = false };
            try
            {
                // Save new todo to the database
                Uri baseAddress = Http.BaseAddress;
                var baseUrl = baseAddress;
                var response = await Http.PostAsJsonAsync(baseUrl + "Todos/", newTask);
                var responseContent = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Response content: {responseContent}");
                if (response.IsSuccessStatusCode)
                {
                    if (response.Content.Headers.ContentLength >0)
                    {
                        var createdTodo = await response.Content.ReadFromJsonAsync<Todos>();
                        if (createdTodo != null)
                        {
                            todos.Add(createdTodo);
                            StateHasChanged();
                        }
                    }
                    newTodo = string.Empty;
                }
                else
                {
                    Console.WriteLine($"Failed to create new todo: {response.StatusCode}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error adding todo: {ex.Message}");
            }
        }
    }

    private async Task UpdateTodo(Todos todo)
    {
        try
        {
            // Ideally, you'll need to create an "Update" API endpoint in your backend to handle updates
            // For example: PUT /Todos/{id}
            //var response = await Http.PutAsJsonAsync($"https://localhost:7251/Todos/{todo.ID}", todo);
            Uri baseAddress = Http.BaseAddress;
            var baseUrl = baseAddress;
            var response = await Http.PutAsJsonAsync(baseUrl + $"Todos/{todo.ID}", todo);

            if (!response.IsSuccessStatusCode)
            {
                Console.WriteLine($"Failed to update todo: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating todo: {ex.Message}");
        }
    }
}
